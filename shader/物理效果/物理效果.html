<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

</body>
<script src="https://cdn.jsdelivr.net/npm/three@0.131.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.131.1/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.131.1/examples/js/shaders/CopyShader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.131.1/examples/js/postprocessing/ShaderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.131.1/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.131.1/examples/js/postprocessing/OutlinePass.js"></script>
<!--拖拽功能-->
<script src="https://cdn.jsdelivr.net/npm/three@0.131.1/examples/js/controls/DragControls.js"></script>

<script src="https://cdn.jsdelivr.net/npm/three@0.131.1/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.131.1/examples/js/renderers/CSS2DRenderer.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/23.1.1/tween.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.131.1/examples/js/loaders/RGBELoader.js"></script>
<script type="module">

  async function loadShader (url) {
    const response = await fetch(url)
    return await response.text()
  }

  const vertexShaderSource = await loadShader('./vertex.glsl')
  const fragmentSource = await loadShader('./fragment.glsl')
  console.log('==请求信息==')
  console.log(vertexShaderSource)
  console.log(fragmentSource)
  // 创建一个场景.
  const scene = new THREE.Scene()
  scene.background = new THREE.Color(0x87CEEB)
  const rgbeLoader = new THREE.RGBELoader()
  rgbeLoader.load('./sunset_fairway_1k.hdr', function (texture) {
    texture.mapping = THREE.EquirectangularReflectionMapping
    scene.environment = texture // 设置场景环境
    scene.background = texture // 可选：设置场景背景

    console.log('scene.environment')
    console.log(scene.environment)
    const materialc = new THREE.ShaderMaterial({
      uniforms: {},
      vertexShader: vertexShaderSource,
      fragmentShader: fragmentSource,
      transparent: true,

    })

    const materialc2 = new THREE.MeshPhysicalMaterial({
      color: 0x00ff00
    })

    // 添加自定义 uniforms
    materialc2.onBeforeCompile = (shader) => {
      // 定义自定义 uniform
      shader.uniforms.myTime = { value: 0 }  // 比如传递一个时间参数

      // 修改顶点着色器
      shader.vertexShader = shader.vertexShader.replace(vertexShaderSource)
    }
    // materialc.uniforms.uLightPosition.value.set(110, 30, 100);
    // materialc.uniforms.uColor.value.set(0xff0000);
    // materialc.uniforms.uThickness.value = 0.2;
    // materialc.uniforms.uRoughness.value = 0.5;
    // materialc.uniforms.uTransmission.value = 0.8;
    // 正方体
    // const cftGeometry = new THREE.BoxGeometry(50, 50, 50)
    // 正方形
    // const cftGeometry = new THREE.BoxGeometry(100, 100)
    // 确保面数足够.
    const cftGeometry = new THREE.BoxBufferGeometry(100, 100, 1, 100, 100, 1)

    // const mesh = new THREE.Mesh(cftGeometry, materialc)
    const mesh = new THREE.Mesh(cftGeometry, materialc2)
    mesh.position.set(0, 0, 0)
    scene.add(mesh)
  })
  // 创建一个相机.
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000)
  // 创建一个几何体.
  const geometry = new THREE.BoxGeometry(1, 1, 1)
  const material = new THREE.MeshBasicMaterial({ color: 0x00ff0 })
  const cube = new THREE.Mesh(geometry, material)
  scene.add(cube)
  camera.position.z = 50
  camera.position.x = 50
  camera.position.y = 50
  camera.lookAt(0, 0, 0)

  const renderer = new THREE.WebGLRenderer()
  renderer.setSize(window.innerWidth, window.innerHeight)
  document.body.appendChild(renderer.domElement)

  cube.rotation.x += 0.01
  cube.rotation.y += 0.01
  // 辅助观察坐标系.
  const axesHelper = new THREE.AxesHelper(10000)
  scene.add(axesHelper)

  // 动画.
  cube.name = 'Box'
  // 时间轴.
  const times = [0, 3, 6]
  // times 中三个不同时间点对应的不同的位置.
  const values = [0, 0, 0, 10, 0, 0, 0, 0, 10]
  const posKF = new THREE.KeyframeTrack('Box.position', times, values)
  const clip = new THREE.AnimationClip('test', 6, [posKF])
  const mixer = new THREE.AnimationMixer(cube)
  const clipAction = mixer.clipAction(clip)
  clipAction.play()

  const clock = new THREE.Clock()
  // 增加一个平行光.
  const directionalLight = new THREE.DirectionalLight(0xff0000, 1)
  directionalLight.position.set(110, 30, 100)
  scene.add(directionalLight)

  // const materialc = new THREE.RawShaderMaterial({
  //   uniforms: {},
  //   vertexShader: vertexShaderSource,
  //   fragmentShader: fragmentSource,
  //   // wireframe: true,
  // })

  // 创建一个物理材质圆球.
  const sphereGeometry = new THREE.SphereGeometry(20, 32, 32)
  const sphereMaterial = new THREE.MeshPhysicalMaterial({
    transmission: 1,
    thickness: 0.1,
    roughness: 0.2,
  })
  const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial)
  sphere.position.set(1, 60, 1)
  scene.add(sphere)

  function loop () {
    requestAnimationFrame(loop)
    const frameT = clock.getDelta()
    mixer.update(frameT)
    // 更新摄像机位置
    // materialc.uniforms.uCameraPosition.value.copy(camera.position);
    renderer.render(scene, camera)
  }

  // 增加相机控件.
  const controls = new THREE.OrbitControls(camera, renderer.domElement)
  controls.addEventListener('change', function () {
    renderer.render(scene, camera)
  })
  loop()

</script>
</html>